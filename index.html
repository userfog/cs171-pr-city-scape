<!DOCTYPE html>
<html>
<head>
  <link rel="apple-touch-icon" sizes="57x57" href="images/fav.ico/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="images/fav.ico/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="images/fav.ico/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="images/fav.ico/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="images/fav.ico/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="images/fav.ico/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="images/fav.ico/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="images/fav.ico/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="images/fav.ico/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="images/fav.ico/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="images/fav.ico/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="images/fav.ico/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="images/fav.ico/favicon-16x16.png">
  <link rel="manifest" href="images/fav.ico/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="images/fav.ico/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
  <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="js/d3.v3.min.js"></script>
  <script type="text/javascript" src="js/nprogress.min.js"></script>
  <script type="text/javascript" src="js/moment.js"></script>
  <script type="text/javascript" src="js/helper.js"></script>
  <script type="text/javascript" src="js/topojson.v1.min.js"></script>
  <script type="text/javascript" src="js/queue.v1.min.js"></script>
  <script type="text/javascript" src="js/d3.tip.js"></script>
  <script type="text/javascript" src="js/d3.legend.js"></script>
  <script type="text/javascript" src="js/SocrataModel.js"></script>
  <script type="text/javascript" src="js/MapVis.js"></script>
  <script type="text/javascript" src="js/sunburst.js"></script>
  <script type="text/javascript" src="js/BarChartVis.js"></script>
  <script type="text/javascript" src="js/timeline.js"></script>
  <script type="text/javascript" src="js/OvertimeVis.js"></script>
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css"/>
  <link rel='stylesheet' type="text/css" href='https://fonts.googleapis.com/css?family=PT+Sans:400,700'/>
  <link rel="stylesheet" type="text/css" href="style/nprogress.css"/>
  <link rel="stylesheet" type="text/css" href="style/style.css"/>
</head>
<body>
  <div class = "header">
  <img src="images/header.jpg" alt="Chicago Skyline" style="width:100%;height:20%">
  </div>
  </br>
  <div class="row">
    <div id="overtime" class="col-md-6">
    </div>
    <div id="writeup" class="col-md-6">
    <p> Over the last decade, crime rates have gone down in the city of Chicago (see graph at left).  For our project, we wanted to delve deeper into this statistic, aiming to answer the following questions:</p> <p><strong>What types of crime occur in Chicago</strong>, and where? How do these types of crime sort differientally among neighborhoods in Chicago? <strong>How have rates of these crimes changed with time </strong>? Do we notice <strong> differences in arrest rate </strong> by time or neighborhood? </p> <p> See text and video below to learn how to use our interactive visualization. </p></div>
  </div> </br> </br>
  <div id="project-info" style="height:400px">
    <div id="video" class="col-md-6" style="text-align: center">
      <iframe width="420" height="315" src="https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=0" frameborder="0" allowfullscreen></iframe>
    </div>
    <div id="data-etc" class="col-md-6" style="height: 350px">
      <h4> How to use our visualization: </h4>
      <p> Use the sunburst to select the year of interest and browse the crime hierarchy, which follows a PRIMARY TYPE > DESCRIPTION > LOCATION paradigm. Click on a crime type or location to update the map and timeline to display that item alone. </p>
      <p> At the top level (all crime types) the timeline can be brushed to update the sunburst and map with crimes for the selected portion of the year. </p>
      <p> Finally, hover over neighborhoods on the map to view demographics, income data, and month-by-month arrest statistics. </p>
    </br>
      <p> The main data for this project came from the <a href="https://data.cityofchicago.org/Public-Safety/Crimes-2001-to-present/ijzp-q8t2">City of Chicago Data Portal</a>.
      Additional data on demographic information came from <a href="http://www.robparal.com/ChicagoCommunityAreaData.html"> robparal.com. </a></p>
      <p>View our <a href="https://github.com/userfog/cs171-pr-city-scape"> GitHub repository for this project. </a> View our <a href="https://github.com/userfog/cs171-pr-city-scape/blob/master/City%20Scape%20Project%20Book.pdf"> Process Book. </a></p>
    </div>
  </div>
  </br>
  <h2 class="text-center" id="currentSelection"></h2>
  <div id="year">
    Year:
    <select>
      <option value="2015">2015</option>
      <option value="2014">2014</option>
      <option value="2013">2013</option>
      <option value="2012">2012</option>
      <option value="2011">2011</option>
      <option value="2010">2010</option>
      <option value="2009">2009</option>
      <option value="2008">2008</option>
      <option value="2007">2007</option>
      <option value="2006">2006</option>
      <option value="2005">2005</option>
      <option value="2004">2004</option>
      <option value="2003">2003</option>
      <option value="2002">2002</option>
      <option value="2001">2001</option>
    </select>
  </div>
  <div class="row">
    <div class="col-md-4">
      <div id="timeline">
      </div>
      <div id="sunburst" style="height=450px">
      </div>
      <!--<div id = "resolution">
        Resolution:
        <select>
          <option value="getDay" selected>Day</option>
          <option value="getMonth">Month</option>
          <option value="getYear">Year</option>
        </select>
      </div> -->
    </div>
    <div class="col-md-8" >
      <div class="row">
        <span class="pull-left">
          <div class="col-md-6" id="mapvis">
          </div>
        </span>
        <div class="col-md-4" id="maphover">
          <div class="row">
            <span class="pull-left">
              <div class="col-md-4" id="tableDemographics">
              </div>
            </span>
            <div class="col-md-2" id="tableIncome">
            </div>
          </div>
          <div class="row">
            <p id="quantity" class="row"></p>
            <div id="barVis">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
 <footer class="site-footer">
  <div class="wrap" style="text-align: center">
    <h2 class="footer-heading">Made for CS171 <strong> &middot; </strong> <a href="http://cs171.org">  cs171.org  </a> <strong> &middot; </strong>  Harvard University </h2>
    <div>
    <h2 class="footer-heading">
    <a href="mailto:zacharyfogelson@college.harvard.edu"><span>Contact Us<span></a> <strong> &middot; </strong>
          <a href="https://github.com/userfog/cs171-pr-city-scape">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path>
              </svg>
            </span>
            <span class="username">View Source</span>
          </a>
      </h2>
    </div>
  </div>
</footer>
<script type="text/javascript">
  var state = {
    "ready": false,
    "crime_filters" : [],
    "time_filters" : [],
    "year" : 2015,
    "changed" : true,
    "set_time" : function (ex){
      if(!ex 
        || ex.length == 0 
        || ex[0] == "undefined"
        || ex[1] == "undefined"
        || calendarCompare(ex[0], ex[1])){
          this.changed = true;
          this.time_filters = [];
      }
      if(!isSame(ex, this.time_filters, "time")){
        this.changed = true;
        this.time_filters = ex;
      }
    },
    "set_crime" : function (filters){
      var next = filters || [];
      if(!isSame(next, this.crime_filters, "crime")){
        this.changed = true;
        this.crime_filters = next;
      }
    },
    "genQuery" : function () {
      var timeQ = "", crimeQ = "";
      if(this.time_filters.length > 0 
        && state.time_filters[0] != undefined
        && state.time_filters[1] != undefined
        && !calendarCompare(state.time_filters[0], state.time_filters[1])){
        timeQ = "date>%27{0}%27%20and%20date<%27{1}%27".format(getReadableDate(state.time_filters[0])
          , getReadableDate(state.time_filters[1]));
      } else{
        timeQ = "date>%27{0}-01-01%27and%20date<%27{1}-12-31%27".format(state.year, state.year);
      }
      if(this.crime_filters.length > 0){
        for(var i = 0; i < this.crime_filters.length; i++){
          crimeQ += "%20and%20{0}=%27{1}%27".format(this.crime_filters[i].key, this.crime_filters[i].value);
        }
      }
      return timeQ + crimeQ;
    },
    "set_year" : function (next) {
      if(this.year != next){
        this.year = next;
        this.changed = true;
      }
    }
  }
  queue().defer(d3.json, "map/chicago.json")
        .defer(d3.json, "data/2000_2010.json")
        .defer(d3.json, "data/income_2006_2010.json")
        .defer(d3.json, "data/overtime.json")
        .await(ready);
  function ready(error, chicago, _2000_2010, _income, overtime){

        var MyEventHandler = new Object();
        var MySilencer  = new Object();

        var MySocrataModel = new SocrataModel("https://data.cityofchicago.org", "ijzp-q8t2", "DylLLVyY2RqAMdaOKMSE0k2Bg", MyEventHandler);

        var BarSocrataModel = new SocrataModel("https://data.cityofchicago.org", "ijzp-q8t2", "DylLLVyY2RqAMdaOKMSE0k2Bg", MyEventHandler);
        
        var MyMapVis = new MapVis(d3.select("#mapvis"), chicago, _2000_2010, _income, MySocrataModel, MyEventHandler);

        var MySunburst = new Sunburst(d3.select("#sunburst"), MyEventHandler, MySocrataModel);

        var MyBarChart = new BarChartVis(d3.select("#barVis"), MyEventHandler)

        var MyTimeline = new Timeline(d3.select("#timeline"), MyEventHandler)

        var MyOvertime = new OvertimeVis(d3.select("#overtime"), MySilencer)

        /* var res = d3.select("#resolution").select("select").on("change", function(){
          var timeArgs = MySocrataModel.timeWrangle(MySocrataModel, this.value);
          MyTimeline.onSelectionChange(timeArgs);
        }); */

        var yearSelector = d3.select("#year").select("select").on("change", function(){
          state.set_year(this.value);
          if(!state.changed) return;
          init(state.year);
        })

        var currentSelection = d3.select("#currentSelection");

        currentSelection.html(convertFiltersToTitle());

        $(MyEventHandler).bind("barChartInit", function(event, event_args){
          NProgress.start();
          state.community_area = "Total";
          BarSocrataModel.get("$select=date,arrest,community_area&$order=date ASC%20&$where={0}".format(state.genQuery())
              , BarSocrataModel.wrangleBarChartRequest
              , 0, 50000, true);
        })

        $(MyEventHandler).bind("loadingDone", function(){
           state.ready = true 
           NProgress.done();
        });
       
        $(MyEventHandler).bind("selectionChanged", function(event, event_args){
          currentSelection.html(convertFiltersToTitle());
          if(!state.changed) return;
          //var resolution = d3.select("#resolution").selectAll("select").property("value");
          resolution = "getDay";
          NProgress.start();
          MySocrataModel.wrangleSelectSunburst(MySocrataModel, event_args, resolution);
          state.ready = false;
          
        })

        $(MyEventHandler).bind("overtimeReady", function(event, event_args){
          if(state.year == moment().year)
            overtime.push({"date": 2015, "count":state.length})
          MyOvertime.initData(overtime)
        })

        $(MyEventHandler).bind("mapVisDataReady", function(event, event_args){
          MyMapVis.choropleth(event_args[0], event_args[1]);
        });

        $(MyEventHandler).bind("sunburstDataReady", function(event, event_args){
          MySunburst.initData(event_args);
        });

        $(MyEventHandler).bind("communityAreaChanged", function(event, event_args){
          MyBarChart.updateDisplay(MyBarChart, event_args[0], event_args[1]);
        });

        $(MyEventHandler).bind("barChartDataReady", function(event, event_args){
          MyBarChart.initData(event_args, "Total", MyMapVis.colorRange || "#FFCC44");
        });

        $(MyEventHandler).bind("timeDataReady", function(event, event_args){
          MyTimeline.initData(event_args);
        });

        $(MyEventHandler).bind("timeUpdate", function(event, event_args){
          MyTimeline.onSelectionChange(event_args);
        });

        $(MyEventHandler).bind("timeChange", function(event, event_args){
          if(!state.changed) return;
          currentSelection.html(convertFiltersToTitle);
          NProgress.start();
          MySocrataModel.wrangleTimeChange(MySocrataModel);
        }); 

        function init(yr) {
          NProgress.start();
          MySocrataModel.get("$where=date>%27{0}-01-01%27and%20date<%27{1}-12-31%27&$select=arrest,date,community_area,primary_type,description,location_description&$order=date%20ASC".format(yr, yr)
            , MySocrataModel.wrangleRequest
            , 0, 50000, true);
        }

        init(state.year);

  }

var getInnerWidth = function(element) {
        var style = window.getComputedStyle(element.node(), null);
        return parseInt(style.getPropertyValue('width'));
}

var  convertFiltersToTitle = function() {
  var  crime, time;
  if(typeof state.crime_filters == "undefined" 
    ||state.crime_filters.length == 0){
        crime = "All Crimes";
  } else{
      if (state.crime_filters.length == 1){
        crime = "<small>All</small> {0}".format(state.crime_filters[0].value)
      } else if (state.crime_filters.length == 2){
        crime = "<small>All</small> {1} <small>which was</small> {0}".format(state.crime_filters[0].value, state.crime_filters[1].value)
      } else{
        crime = "<small>All</small> {2} <small>which was</small> {1} <small>at/on a</small> {0}".format(state.crime_filters[0].value, state.crime_filters[1].value, state.crime_filters[2].value); 
      }
  }
  if(typeof state.time_filters == "undefined"
      || typeof state.time_filters[0] == "undefined"
      || typeof state.time_filters[1] == "undefined"
      || state.time_filters.length < 2
      || calendarCompare(state.time_filters[0], state.time_filters[1])){
        time = "";
  } else{
      time = " <small>between</small> {0} <small>and</small> {1}".format(
        getReadableDate(state.time_filters[0])
        , getReadableDate(state.time_filters[1]));
  }
  return crime + time;
}

</script>
</html>
