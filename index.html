<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
  <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>
  <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="js/nprogress.min.js"></script>
  <script type="text/javascript" src="js/helper.js"></script>
  <script src="js/SocrataModel.js"></script>
  <script src="js/MapVis.js"></script>
  <script src="js/sunburst.js"></script>
  <script src="js/BarChartVis.js"></script>
  <script src="js/timeline.js"></script>
  <link rel="stylesheet" type="text/css" href="style/nprogress.css"/>
  <link rel="stylesheet" type="text/css" href="style/style.css"/>
</head>
<body>
  <div class="row">
    <h2 class="text-center" id="currentSelection"></h2>
  </div>
  <div class="row">
    <div class="col-md-4">
      <div id="sunburst">
      </div>
      <div id = "resolution">
        Resolution:
        <select>
          <option value="getDay" selected>Day</option>
          <option value="getMonth">Month</option>
          <option value="getYear">Year</option>
        </select>
      </div>
      <div id="timeline">
      </div>
    </div>
    <div class="col-md-4" id="mapvis">
    </div>
    <div class="col-md-3" id="maphover">
      <div class="row">
        <div id="table">
        </div>
      </div>
      <p id="quantity" class="row"></p>
      </div>
      <div class="row">
        <div class="col-md-6" id="barVis">
        </div>
        <div class="col-md-6" id="barLegend">
          <p>Legend</p>
        </div>
      </div>
    </div>
  </div>
<script type="text/javascript">

  var state = {
    "crime_filters" : [],
    "time_filters" : [],
    "changed" : true,
    "set_time" : function (ex){
      var next = (ex[0].getTime() == ex[1].getTime()) ? [] : ex;
      if(!isSame(next, this.time_filters, "time")){
        this.changed = true;
        this.time_filters = next;
      }
    },
    "set_crime" : function (filters){
      var next = filters || [];
      if(!isSame(next, this.crime_filters, "crime")){
        this.changed = true;
        this.crime_filters = next;
      }
    }
  }

  queue().defer(d3.json, "map/chicago.json")
        .defer(d3.json, "data/2000_2010.json")
        .await(ready);

  function ready(error, chicago, _2000_2010){

        var MyEventHandler = new Object();

        var MySocrataModel = new SocrataModel("https://data.cityofchicago.org", "ijzp-q8t2", "DylLLVyY2RqAMdaOKMSE0k2Bg", MyEventHandler);

        var BarSocrataModel = new SocrataModel("https://data.cityofchicago.org", "ijzp-q8t2", "DylLLVyY2RqAMdaOKMSE0k2Bg", MyEventHandler);
        
        var MyMapVis = new MapVis(d3.select("#mapvis"), chicago, _2000_2010, MySocrataModel, MyEventHandler);

        var MySunburst = new Sunburst(d3.select("#sunburst"), MyEventHandler, MySocrataModel);

        var MyBarChart = new BarChartVis(d3.select("#barVis"), MyEventHandler)

        var MyTimeline = new Timeline(d3.select("#timeline"), MyEventHandler)

        var res = d3.select("#resolution").select("select").on("change", function(){
          MySocrataModel.timeWrangle(MySocrataModel, true, this.value);
        });

        var currentSelection = d3.select("#currentSelection")
          .html(convertFiltersToTitle);

        $(MyEventHandler).bind("communityAreaChanged", function(event, event_args){
          BarSocrataModel.get("$select=date,arrest&$where=community_area=%27{0}%27".format(event_args), MySocrataModel.barChartWrangler);
        })
       
        $(MyEventHandler).bind("selectionChanged", function(event, event_args){
          if(!state.changed) return;
          currentSelection.html(convertFiltersToTitle);
          MySocrataModel.getDisplayData();
          MySocrataModel.mapWrangle();
          MySocrataModel.timeWrangle(MySocrataModel, true, d3.select("#resolution").selectAll("select").property("value"));
          state.changed = false;

        })

        $(MyEventHandler).bind("mapVisDataReady", function(event, event_args){
          MyMapVis.choropleth(event_args);
        });

        $(MyEventHandler).bind("sunburstDataReady", function(event, event_args){
          MySunburst.initData(event_args);
        });

        $(MyEventHandler).bind("barChartDataReady", function(event, event_args){
          MyBarChart.initData(event_args);
        });

        $(MyEventHandler).bind("timeDataReady", function(event, event_args){
          MyTimeline.initData(event_args);
        });

        $(MyEventHandler).bind("timeUpdate", function(event, event_args){
          MyTimeline.onSelectionChange(event_args);
        });

        $(MyEventHandler).bind("timeChange", function(event, event_args){
          if(!state.changed) return;
          currentSelection.html(convertFiltersToTitle);
          MySocrataModel.getDisplayData();
          MySocrataModel.mapWrangle();
          MySocrataModel.sunburstWrangle();
          state.changed = false;
        }); 

        MySocrataModel.get("$where=year='2004'&$select=date,community_area,primary_type,description,location_description,%20COUNT(primary_type)&$group=date,community_area,primary_type,description,location_description&$order=date ASC", MySocrataModel.wrangleRequest, 0, 50000);

        // BarSocrataModel.get("$select=date,arrest&$limit=50000", MySocrataModel.barChartWrangler);

  }

var getInnerWidth = function(element) {
        var style = window.getComputedStyle(element.node(), null);
        return parseInt(style.getPropertyValue('width'));
}

var  convertFiltersToTitle = function() {
  var  crime, time;
  if(typeof state.crime_filters == "undefined" 
    ||state.crime_filters.length == 0){
        crime = "All Crimes";
  } else{
      if (state.crime_filters.length == 1){
        crime = "<small>All</small> {0}".format(state.crime_filters[0].value)
      } else if (state.crime_filters.length == 2){
        crime = "<small>All</small> {1} <small>which was</small> {0}".format(state.crime_filters[0].value, state.crime_filters[1].value)
      } else{
        crime = "<small>All</small> {2} <small>which was</small> {1} <small>at/on a</small> {0}".format(state.crime_filters[0].value, state.crime_filters[1].value, state.crime_filters[2].value); 
      }
  }
  if(typeof state.time_filters == "undefined" 
    || state.time_filters.length == 0
    || state.time_filters[0].getTime() == 
        state.time_filters[1].getTime()){
        time = "";
  } else{
      time = " <small>between</small> {0} <small>and</small> {1}".format(
        getReadableDate(state.time_filters[0])
        , getReadableDate(state.time_filters[1]));
  }
  return crime + time;
}

</script>
</body>
</html>
